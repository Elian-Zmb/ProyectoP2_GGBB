<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Portal | Sociedad Financiera</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --sidebar-width: 260px;
            --primary-dark: #0f172a;
            --primary-accent: #3b82f6;
            --bg-light: #f1f5f9;
            --text-dark: #1e293b;
            --text-muted: #64748b;
        }
        body { 
            background-color: var(--bg-light); 
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            overflow-x: hidden;
        }
        .sidebar {
            height: 100vh;
            width: var(--sidebar-width);
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--primary-dark);
            color: white;
            z-index: 1000;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.05);
        }
        .brand-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 3rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .nav-link {
            color: #94a3b8;
            padding: 0.8rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.05);
            color: white;
            transform: translateX(5px);
        }
        .nav-link.active {
            background-color: var(--primary-accent);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .nav-link i { width: 20px; text-align: center; }
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem 3rem;
        }
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            background: white;
            transition: transform 0.2s;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #f1f5f9;
            padding: 1.2rem 1.5rem;
            border-radius: 16px 16px 0 0 !important;
        }
        .money-card {
            position: relative;
            overflow: hidden;
            color: white;
            border-radius: 20px;
        }
        
        .money-card-1 {
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1579546929518-9e396f3cc809?auto=format&fit=crop&q=80&w=800');
            background-size: cover;
        }
        
        .money-card-2 {
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://images.unsplash.com/photo-1634117622592-114e3024ff27?auto=format&fit=crop&q=80&w=800');
            background-size: cover;
        }
        .table thead th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
            background-color: #f8fafc;
            border: none;
            padding: 1rem;
        }       
        .table tbody td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            color: var(--text-dark);
        }
        .status-dot {
            height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px;
        }
        .bg-soft-success { background-color: #dcfce7; color: #166534; }
        .bg-soft-warning { background-color: #fef9c3; color: #854d0e; }
        .bg-soft-danger { background-color: #fee2e2; color: #991b1b; }
        .bg-soft-primary { background-color: #dbeafe; color: #1e40af; }
        .nav-pills .nav-link {
            background: transparent;
            color: var(--text-muted);
            border: 1px solid transparent;
            font-weight: 500;
        }
        .nav-pills .nav-link.active {
            background: white;
            color: var(--primary-accent);
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .avatar-circle {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="brand-logo">
            <img src="https://cdn-icons-png.flaticon.com/512/4144/4144379.png" width="32" style="filter: invert(1);">
            <span class="fs-5 fw-bold tracking-tight">Sociedad<span class="text-primary">App</span></span>
        </div>

        <ul class="nav flex-column w-100">
            <li class="nav-item">
                <a href="{{ url_for('routes.dashboard', section='resumen') }}" 
                   class="nav-link {% if section == 'resumen' %}active{% endif %}">
                    <i class="fa-solid fa-wallet"></i>
                    <span>Mi Billetera</span>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="{{ url_for('routes.dashboard', section='creditos') }}" 
                   class="nav-link {% if section == 'creditos' %}active{% endif %}">
                    <i class="fa-solid fa-chart-pie"></i>
                    <span>Mis Créditos</span>
                </a>
            </li>

            {% if usuario.role in ['SECRETARIO', 'DIRECTOR', 'TESORERO'] %}
            <li class="nav-item mt-4 mb-2">
                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem; letter-spacing: 1px; padding-left: 1rem;">Administración</small>
            </li>
            <li class="nav-item">
                <a href="{{ url_for('routes.dashboard', section='admin') }}" 
                   class="nav-link {% if section == 'admin' %}active{% endif %}" style="color: #cbd5e1;">
                    {% if usuario.role == 'SECRETARIO' %}<i class="fa-solid fa-folder-open"></i>
                    {% elif usuario.role == 'DIRECTOR' %}<i class="fa-solid fa-gavel"></i>
                    {% else %}<i class="fa-solid fa-vault"></i>{% endif %}
                    <span>{{ page_title }}</span>
                </a>
            </li>
            {% endif %}
        </ul>

        <div class="mt-auto">
            <a href="{{ url_for('auth.logout') }}" class="nav-link text-danger">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                <span>Cerrar Sesión</span>
            </a>
        </div>
    </nav>

    <div class="main-content">

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'error' else 'danger' }} border-0 shadow-sm alert-dismissible fade show mb-4" role="alert">
                        {% if category == 'success' %}<i class="fa-solid fa-circle-check me-2"></i>{% endif %}
                        {{ message | safe }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1">Hola, {{ usuario.full_name.split()[0] }}</h2>
                <p class="text-muted mb-0">Bienvenido a tu panel financiero</p>
            </div>
            <div class="d-flex align-items-center gap-3 bg-white px-4 py-2 rounded-pill shadow-sm">
                <div class="text-end lh-1">
                    <span class="d-block small text-muted fw-semibold">Scoring</span>
                    <span class="fw-bold text-{{ 'success' if usuario.scoring_label == 'A' else 'warning' }}">{{ usuario.scoring_label }}</span>
                </div>
                <div style="height: 30px; border-left: 1px solid #e2e8f0;"></div>
                <div class="d-flex align-items-center gap-2">
                    <div class="text-end lh-1 d-none d-md-block">
                        <span class="d-block fw-bold small">{{ usuario.role }}</span>
                        <span class="d-block text-muted" style="font-size: 0.7rem;">ID: {{ usuario.id }}</span>
                    </div>
                    <img src="https://ui-avatars.com/api/?name={{ usuario.full_name }}&background=0D8ABC&color=fff" class="avatar-circle" alt="Profile">
                </div>
            </div>
        </div>

        
        {% if section == 'resumen' %}
            <div id="seccion-resumen">
                {% if usuario.role in ['SOCIO', 'SECRETARIO', 'DIRECTOR', 'TESORERO'] %}
                <div class="row mb-5">
                    <div class="col-md-6 mb-3">
                        <div class="card money-card money-card-1 h-100 shadow-lg">
                            <div class="card-body d-flex flex-column justify-content-between p-4">
                                <div class="d-flex justify-content-between">
                                    <span class="opacity-75"><i class="fa-solid fa-wallet me-2"></i>Saldo Disponible</span>
                                    <i class="fa-brands fa-cc-visa fs-3 opacity-50"></i>
                                </div>
                                <div class="mt-4">
                                    <h1 class="display-5 fw-bold mb-0">${{ usuario.wallet_balance }}</h1>
                                    <small class="opacity-75">Actualizado hoy</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card money-card money-card-2 h-100 shadow-lg">
                            <div class="card-body d-flex flex-column justify-content-between p-4">
                                <div class="d-flex justify-content-between">
                                    <span class="opacity-75"><i class="fa-solid fa-piggy-bank me-2"></i>Capital Social</span>
                                    <i class="fa-solid fa-building-columns fs-3 opacity-50"></i>
                                </div>
                                <div class="mt-4">
                                    <h1 class="display-5 fw-bold mb-0">${{ usuario.capital_contributed }}</h1>
                                    <small class="opacity-75">Tus acciones</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center bg-transparent border-0 pt-4 px-4">
                        <h5 class="fw-bold mb-0 text-dark">Últimos Movimientos</h5>
                        <button class="btn btn-sm btn-light text-muted"><i class="fa-solid fa-download me-1"></i> Exportar</button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table mb-0">
                                <thead class="bg-light"><tr><th class="ps-4">Tipo</th><th>Descripción</th><th class="text-end pe-4">Monto</th></tr></thead>
                                <tbody>
                                    {% if transacciones %}
                                        {% for tx in transacciones %}
                                        <tr>
                                            <td class="ps-4">
                                                <span class="badge bg-light text-dark border fw-normal">{{ tx.type }}</span>
                                            </td>
                                            <td class="text-secondary fw-500">{{ tx.description }}</td>
                                            <td class="text-end fw-bold pe-4" style="font-family: monospace; font-size: 1.1rem;">${{ tx.amount }}</td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="3" class="text-center py-5 text-muted"><img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="60" class="mb-3 opacity-25 d-block mx-auto">Sin movimientos recientes.</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}


        {% if section == 'creditos' %}
            <div id="seccion-creditos">
                
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="fw-bold mb-1">Gestión de Créditos</h4>
                        <p class="text-muted small mb-0">Administra tus préstamos y solicitudes</p>
                    </div>
                    <button type="button" class="btn btn-primary shadow-sm px-4 rounded-pill" data-bs-toggle="modal" data-bs-target="#modalSolicitud">
                        <i class="fa-solid fa-plus me-2"></i>Nueva Solicitud
                    </button>
                </div>

                <div class="card mb-4">
                    <div class="card-body p-2 bg-light rounded-3">
                        <ul class="nav nav-pills nav-fill" id="pills-tab" role="tablist">
                            <li class="nav-item">
                                <button class="nav-link active rounded-3" id="tab-activos" data-bs-toggle="pill" data-bs-target="#content-activos" type="button">
                                    Activos <span class="badge bg-secondary ms-1 rounded-pill">{{ c_activos|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link rounded-3" id="tab-pendientes" data-bs-toggle="pill" data-bs-target="#content-pendientes" type="button">
                                    En Trámite <span class="badge bg-warning text-dark ms-1 rounded-pill">{{ c_pendientes|length }}</span>
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link rounded-3" id="tab-rechazados" data-bs-toggle="pill" data-bs-target="#content-rechazados" type="button">
                                    Rechazados
                                </button>
                            </li>
                            <li class="nav-item">
                                <button class="nav-link rounded-3" id="tab-finalizados" data-bs-toggle="pill" data-bs-target="#content-finalizados" type="button">
                                    Historial
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="content-activos">
                        {% if c_activos %}
                            {% for p in c_activos %}
                            <div class="card border-0 shadow-sm mb-4 overflow-hidden">
                                <div class="card-body p-0">
                                    <div class="row g-0">
                                        <div class="col-md-3 bg-soft-success p-4 d-flex flex-column justify-content-center text-center">
                                            <span class="text-success fw-bold small text-uppercase mb-2">Monto Actual</span>
                                            <h2 class="fw-bold text-success mb-0">${{ p.amount }}</h2>
                                            <span class="badge bg-success mt-2 align-self-center">ACTIVO</span>
                                        </div>
                                        <div class="col-md-9 p-4">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h5 class="fw-bold">Préstamo #{{ p.id }}</h5>
                                                    <p class="text-muted mb-0">Tasa de interés: <span class="fw-bold text-dark">{{ p.interest_rate }}%</span></p>
                                                </div>
                                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" type="button" data-bs-toggle="collapse" data-bs-target="#t_act_{{ p.id }}">
                                                    Ver Tabla de Pagos <i class="fa-solid fa-chevron-down ms-1"></i>
                                                </button>
                                            </div>
                                            
                                            <div class="collapse mt-3" id="t_act_{{ p.id }}">
                                                <div class="table-responsive rounded border">
                                                    <table class="table table-sm table-striped mb-0 text-center small">
                                                        <thead class="table-light"><tr><th>#</th><th>Vencimiento</th><th>Total</th><th>Estado</th></tr></thead>
                                                        <tbody>
                                                            {% for c in p.cronograma %}
                                                            <tr>
                                                                <td>{{ c.installment_number }}</td>
                                                                <td>{{ c.due_date }}</td>
                                                                <td class="fw-bold">${{ c.total_amount }}</td>
                                                                <td>
                                                                    {% if c.payment_status == 'PAGADO' %}
                                                                        <span class="badge bg-success"><i class="fa-solid fa-check"></i></span>
                                                                    {% else %}
                                                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5 opacity-50">
                                <i class="fa-regular fa-folder-open display-4 mb-3"></i>
                                <p>No tienes créditos activos actualmente.</p>
                            </div>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="content-pendientes">
                        <div class="row">
                        {% if c_pendientes %}
                            {% for p in c_pendientes %}
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <span class="text-muted small text-uppercase">Solicitud #{{ p.id }}</span>
                                                <h3 class="fw-bold mb-0">${{ p.amount }}</h3>
                                            </div>
                                            {% if p.status == 'BORRADOR' %}<span class="badge bg-secondary">Borrador</span>
                                            {% elif p.status == 'EN_REVISION' %}<span class="badge bg-warning text-dark">En Revisión</span>
                                            {% elif p.status == 'POR_DESEMBOLSAR' %}<span class="badge bg-primary">Por Desembolsar</span>{% endif %}
                                        </div>
                                        
                                        <div class="mt-4">
                                            <p class="text-muted small mb-1">Progreso</p>
                                            <div class="progress" style="height: 6px; border-radius: 10px;">
                                                <div class="progress-bar bg-{{ 'secondary' if p.status == 'BORRADOR' else 'warning' if p.status == 'EN_REVISION' else 'primary' }}" 
                                                     role="progressbar" style="width: {{ '25' if p.status == 'BORRADOR' else '50' if p.status == 'EN_REVISION' else '90' }}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="col-12 text-center py-5 text-muted">No hay solicitudes en curso.</div>
                        {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="content-rechazados">
                        {% if c_rechazados %}
                            {% for p in c_rechazados %}
                            <div class="alert alert-danger d-flex justify-content-between align-items-center mb-2 border-0 bg-soft-danger text-danger">
                                <span><i class="fa-solid fa-circle-xmark me-2"></i>Solicitud <strong>#{{ p.id }}</strong> por ${{ p.amount }}</span>
                                <small>No aprobada</small>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-center py-4 text-muted">Historial limpio.</p>
                        {% endif %}
                    </div>

                    <div class="tab-pane fade" id="content-finalizados">
                        <div class="card">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>#ID</th><th>Monto</th><th>Fecha Inicio</th><th>Estado</th></tr></thead>
                                <tbody>
                                    {% if c_finalizados %}
                                        {% for p in c_finalizados %}
                                        <tr><td>{{ p.id }}</td><td>${{ p.amount }}</td><td>{{ p.start_date }}</td><td><span class="badge bg-secondary">Finalizado</span></td></tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="4" class="text-center py-4 text-muted">Aún no hay créditos finalizados.</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}


        {% if section == 'admin' %}
        {% if usuario.role in ['SECRETARIO', 'DIRECTOR', 'TESORERO'] %}
        <div id="seccion-admin">
            <div class="d-flex align-items-center gap-2 mb-4">
                <div class="bg-primary text-white p-2 rounded"><i class="fa-solid fa-user-shield"></i></div>
                <h4 class="mb-0 fw-bold">{{ page_title }}</h4>
            </div>
            
            {% if usuario.role == 'TESORERO' %}
                <div class="card border-danger border-start border-4 mb-5 shadow-sm">
                    <div class="card-header bg-white border-0 py-3"><h5 class="fw-bold text-danger mb-0">Préstamos en Mora</h5></div>
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead class="text-danger"><tr><th>ID</th><th>Usuario</th><th>Monto</th><th>Cuotas</th><th>Acción</th></tr></thead>
                            <tbody>
                                {% if loans_in_mora %}
                                    {% for loan in loans_in_mora %}
                                    <tr>
                                        <td>#{{ loan.id }}</td><td class="fw-bold">{{ loan.full_name }}</td><td>${{ loan.amount }}</td>
                                        <td><span class="badge bg-danger rounded-pill">{{ loan.cuotas_vencidas }}</span></td>
                                        <td><a href="{{ url_for('routes.loan_details', loan_id=loan.id) }}" class="btn btn-sm btn-outline-danger">Cobrar</a></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="5" class="text-center py-4 text-muted">¡Sin mora activa!</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}

            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm mb-5">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">Cartera Activa</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead><tr><th>ID</th><th>Cliente</th><th>Monto</th><th>Estado</th><th>Gestión</th></tr></thead>
                                <tbody>
                                    {% if active_loans_all %}
                                        {% for loan in active_loans_all %}
                                        <tr>
                                            <td class="text-muted">#{{ loan.id }}</td>
                                            <td>
                                                <div class="fw-bold">{{ loan.full_name }}</div>
                                                <small class="text-muted">{{ loan.dni }}</small>
                                            </td>
                                            <td class="fw-bold">${{ loan.amount }}</td>
                                            <td><span class="status-dot bg-{{ 'success' if loan.status == 'ACTIVO' else 'danger' }}"></span> {{ loan.status }}</td>
                                            <td>
                                                <a href="{{ url_for('routes.loan_details', loan_id=loan.id) }}" class="btn btn-sm btn-light border">
                                                    Ver Detalle
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="5" class="text-center py-4">No hay datos.</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {% if loans_to_disburse %}
                    <div class="card border-primary border-start border-4 mb-4">
                         <div class="card-header bg-white"><h5 class="fw-bold text-primary mb-0">Requieren Desembolso</h5></div>
                         <div class="card-body">
                            {% for loan in loans_to_disburse %}
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                <div><strong>{{ loan.full_name }}</strong> espera <span class="text-success fw-bold">${{ loan.amount }}</span></div>
                                <form action="{{ url_for('routes.admin_action') }}" method="POST">
                                    <input type="hidden" name="loan_id" value="{{ loan.id }}">
                                    <button name="action" value="desembolsar" class="btn btn-sm btn-success fw-bold px-3 rounded-pill">Confirmar</button>
                                </form>
                            </div>
                            {% endfor %}
                         </div>
                    </div>
                    {% endif %}

                    <div class="card shadow-sm">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold mb-0">Bandeja de Entrada de Solicitudes</h5>
                        </div>
                        <div class="table-responsive">
                            <table class="table align-middle mb-0">
                                <thead><tr><th>ID</th><th>Solicitante</th><th>Monto</th><th>Estado</th><th>Acciones</th></tr></thead>
                                <tbody>
                                    {% if admin_loans %}
                                        {% for loan in admin_loans %}
                                        <tr>
                                            <td>#{{ loan.id }}</td>
                                            <td class="fw-bold">{{ loan.full_name }}</td>
                                            <td>${{ loan.amount }}</td>
                                            <td>
                                                {% if loan.status == 'BORRADOR' %}<span class="badge bg-secondary">Borrador</span>
                                                {% elif loan.status == 'EN_REVISION' %}<span class="badge bg-warning text-dark">Revisión</span>
                                                {% else %}<span class="badge bg-primary">Listo</span>{% endif %}
                                            </td>
                                            <td>
                                                <form action="{{ url_for('routes.admin_action') }}" method="POST" class="d-flex gap-2">
                                                    <input type="hidden" name="loan_id" value="{{ loan.id }}">
                                                    {% if usuario.role == 'SECRETARIO' and loan.status == 'BORRADOR' %}
                                                        <a href="{{ url_for('routes.review_request', loan_id=loan.id) }}" class="btn btn-sm btn-light border"><i class="fa-solid fa-eye"></i></a>
                                                        <button name="action" value="revisar" class="btn btn-sm btn-primary">Promover</button>
                                                    {% elif usuario.role == 'DIRECTOR' and loan.status == 'EN_REVISION' %}
                                                        <button name="action" value="aprobar" class="btn btn-sm btn-success"><i class="fa-solid fa-check"></i></button>
                                                        <button name="action" value="rechazar" class="btn btn-sm btn-danger"><i class="fa-solid fa-xmark"></i></button>
                                                    {% else %}
                                                        <span class="text-muted small">-</span>
                                                    {% endif %}
                                                </form>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="5" class="text-center py-5 text-muted">Bandeja limpia.</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %} 
        {% endif %}
    </div>

    <div class="modal fade" id="modalSolicitud" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold ms-2">Nueva Solicitud de Crédito</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form action="{{ url_for('routes.web_request_loan') }}" method="POST">
                        <input type="hidden" name="user_id" value="{{ usuario.id }}">
                        
                        <div class="form-floating mb-3">
                            <input type="number" name="amount" class="form-control rounded-3" id="floatAmount" placeholder="Monto" required>
                            <label for="floatAmount">Monto a solicitar ($)</label>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-6">
                                <div class="form-floating">
                                    <select name="duration" class="form-select rounded-3" id="floatDuration">
                                        <option value="3">3 Meses</option>
                                        <option value="6">6 Meses</option>
                                    </select>
                                    <label for="floatDuration">Plazo</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <select name="type" class="form-select rounded-3" id="floatType">
                                        <option value="CORTO_PLAZO">Corto Plazo</option>
                                    </select>
                                    <label for="floatType">Tipo</label>
                                </div>
                            </div>
                        </div>

                        {% if usuario.role == 'USUARIO' %}
                            <div class="mb-4">
                                <label class="small text-muted mb-2 ms-1">Socio Garante (Padrino)</label>
                                <select name="guarantor_id" class="form-select rounded-3 py-3" required>
                                    {% for socio in socios %}
                                    <option value="{{ socio.id }}">{{ socio.full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% else %}
                            <div class="alert alert-success bg-soft-success border-0 d-flex align-items-center gap-3 mb-4 rounded-3">
                                <i class="fa-solid fa-star text-success"></i>
                                <div>
                                    <h6 class="fw-bold mb-0 text-success">Crédito Directo</h6>
                                    <small class="text-success opacity-75">No requieres garante por tu rango.</small>
                                </div>
                            </div>
                        {% endif %}

                        <button type="submit" class="btn btn-primary w-100 py-3 rounded-3 fw-bold shadow-sm">Enviar Solicitud</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>